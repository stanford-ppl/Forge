#!/bin/bash

# check input - perhaps add support for --name $NAME --test --dir $DIR <-- like $FORGE_HOME/src/examples

EXPECTED_ARGS=1
E_BADARGS=65

if [ $# -lt $EXPECTED_ARGS ]
then
  echo "Usage: `basename $0` MyDslName"
  exit $E_BADARGS
fi

fullname="$1"
lowerCaseDSL="optigraph"

# check FORGE_HOME exists

if [ -z "${FORGE_HOME+xxx}" ]; then echo FORGE_HOME is not defined; fi
if [ -z "$FORGE_HOME" -a "${FORGE_HOME+xxx}" = "xxx" ]; then echo FORGE_HOME is set but empty; fi

CURR_DIR=`pwd`

cd $FORGE_HOME

# create necessary directories

#appsHome = "./apps/$fullname"
mkdir -p ./apps/$fullname/src # remove src here? TODO

# copy over template DSLs

cp ./static/TemplateDSL.scala ./src/examples/${fullname}.scala
cp -r ./static/apps/* ./apps/$fullname/

# Insert DSL name in the appropriate place

dest=".apps/$fullname"
os.system("find " + $dest + " -type f -print0 | xargs -0 sed -i \"\" 's/HUMAN_DSL_NAME/"+dsl+"/g'")
os.system("find " + $dest + " -type f -print0 | xargs -0 sed -i \"\" 's/LOWERCASE_DSL_NAME/"+dsl.lower()+"/g'")

dest="./src/examples"
os.system("find " + $dest + " -type f -print0 | xargs -0 sed -i \"\" 's/HUMAN_DSL_NAME/"+dsl+"/g'")
os.system("find " + $dest + " -type f -print0 | xargs -0 sed -i \"\" 's/LOWERCASE_DSL_NAME/"+dsl.lower()+"/g'")
#find ./apps/$fullname -type f -print0 | xargs -0 sed -i "s/HUMAN_DSL_NAME/$fullname/g"
#find ./apps/$fullname -type f -print0 | xargs -0 sed -i "s/LOWERCASE_DSL_NAME/$lowerCaseDSL/g"
#find ./src/examples/ -type f -print0 | xargs -0 sed -i "s/HUMAN_DSL_NAME/$fullname/g"
#find ./src/examples -type f -print0 | xargs -0 sed -i "s/LOWERCASE_DSL_NAME/$lowerCaseDSL/g"

# test compilation
# todo - check errors?
if [ "$2" == "--test" ]
then
  ./bin/update ppl.dsl.forge.examples.${fullname}DSLRunner ${fullname}
  cd published/${fullname}
  bin/delitec HelloWorldInterpreter
  bin/delitec HelloWorldCompiler
  bin/delite HelloWorldCompiler.deg
fi

cd $CURR_DIR
echo "Initialization complete"
